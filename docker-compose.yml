services:
  hatchpod:
    image: ghcr.io/andresmorales07/hatchpod:latest
    container_name: hatchpod
    hostname: hatchpod
    runtime: sysbox-runc
    cap_add:
      - NET_ADMIN
    devices:
      - "/dev/net/tun:/dev/net/tun"
    ports:
      - "2222:2222"
      - "7681:7681"
      - "8080:8080"
      - "60000-60003:60000-60003/udp"
    volumes:
      - home:/home/hatchpod
      - docker-data:/var/lib/docker
    environment:
      - SSH_PASSWORD=${SSH_PASSWORD:-${CLAUDE_USER_PASSWORD:-changeme}}
      - TTYD_USERNAME=${TTYD_USERNAME:-hatchpod}
      - TTYD_PASSWORD=${TTYD_PASSWORD:-changeme}
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_HOSTNAME=${TS_HOSTNAME:-hatchpod}
      - DOTFILES_REPO=${DOTFILES_REPO:-}
      - API_PASSWORD=${API_PASSWORD:-changeme}
      - DOTFILES_BRANCH=${DOTFILES_BRANCH:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f -u \"${TTYD_USERNAME}:${TTYD_PASSWORD}\" http://localhost:7681 && curl -f http://localhost:8080/healthz && docker info > /dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  home:
  docker-data:
